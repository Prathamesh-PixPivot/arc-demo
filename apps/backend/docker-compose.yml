services:
  # âœ… Metadata DB (Master)
  postgres-master:
    image: postgres:14
    container_name: postgres-master
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: master
    ports:
      - "5432:5432"
      - master_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      retries: 5

  # âœ… Cluster: US East
  postgres-us-east:
    image: postgres:14
    container_name: postgres-us-east
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: us-east
    ports:
      - "5433:5432"
      - us_east_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      retries: 5

  # âœ… Cluster: EU West
  postgres-eu-west:
    image: postgres:14
    container_name: postgres-eu-west
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: eu-west
    ports:
      - "5434:5432"
      - eu_west_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      retries: 5

  # âœ… Main Consent API Server
  consent-server:
    build: .
    container_name: consent-manager
    restart: always
    # ðŸ”‘ CRITICAL: Load environment variables from .env file
    env_file: 
      - .env
    depends_on:
      postgres-master:
        condition: service_healthy
      postgres-us-east:
        condition: service_healthy
      postgres-eu-west:
        condition: service_healthy
    ports:
      - "8080:8080"
      # Mount Keys and Docs

volumes:
  master_data:
  us_east_data:
  eu_west_data:
  pgadmin_data:
